# Процесс заявки

!!! warning

    Запити, що використовуються у процессі оновленні данних зі сторони клієнту, використовують [токен доступу](forming-requests.md#_3) та шифрування, що описанне у [формуванні запитів](forming-requests.md#_3).

Для того, щоб почати роботу з цим важким процессом, вам потрібно мати встановленний [socket.io](https://socket.io), він буде повертати `event'и`/`emit'и`, що вам потрібні того, щоб зрозуміти, що якісь данні оновились.
У подальших приклад переважно буде використовутись **Node.js**/**ES6**.

## Вступ до Socket.io, та інше про Real Time
Перед тим як почати роботу з заявкою вам потрібно з'єднатись з нашим WebSocket'ом
Наш `websocket`, що працює на `framework'у` **socket.io**, має такий шлях `https://invoice.wellpay.me/socket.io`.
В результаті підключення до нього, якщо з нашої сторони прийдуть якісь змінни, то ви зможете оновити ці данні у себе.

## Socket.io Emit'и
`connect` - це стандартний emit, що використовується при з'єднанні з WebSocket'ом, в ньому ви повинні у відповідь надіслати **emit** `invoice:join`, у якому ви передаєте UID заявки яку ви хочете обробити.
Після чого ви можете використати, [метод отримання інформації про Invoice](get-invoice.md).
Також важливо знати, що після того як ви під'єднались до нашого WebSocket'у, ми зберігаємо на наших серверах IP того хто приєднався. Надалі ніхто інший крім відправника з цим IP, не зможе оновити данні у цій заявці.
Отже після того як ви під'єднались до Socket'у, зробили **emit** `invoice:join`, після приєднання ви у відповідь від WebSocket'а, отримаєте IP того хто приєднався. Ця інформація буде переданна в **emit** з імененем `ip:send`, який буде містити в собі IP того хто приєднався.

`disconnect` - це стандартний **emit**, що використовується при від'єднанні з WebSocket'ом, він не містить ніякого великого консенсусу для нашого API.

`invoce:refetch` - цей **emit** відправляється з нашої сторони за умови того, що ви під'єднались до нашого WebSocket'у, відправили нам **emit** з `UID`, отримали базову інформацію про заявку. Він відпраляється кожного разу при змінні якихось данних на наших серверах, наприклад у випадку коли трейдер взяв вашу заявку в обробку.

`ip:send` - цей **emit** відправляється одразу після того як ви відправили нам **emit** `invoice:join`, він містить в собі IP того хто приєднався 

## Оновлення данних клієнтом
Клієнту тільки два раза треба оновити данні, щодо заявки. Перший раз при оплаті, другий у випадку того коли трейдер відхиляє оплату і хоче почати спір. Тобто другий раз клієнту потрібно буде викликати метод оновлення данних тільки у випадку, коли йому потрібно буде завантажити фото підтвердження про оплату, а саме URL цього фото.

Для оновлення данних використовується метод `https://api.nltrade.in/method/RemoteInvoiceApi`, більш детально [тут](update-invoice.md#invoic).
Приклад запиту оплати клієнтом заявки, можна побачити ось [тут](update-invoice.md#_3), а приклад запиту додавання фото клієнтом до заявки ось [тут](update-invoice.md#invoic_1).


## Стислий алгоритм проведення заявки
1. Під'єднання до [WebSocket'у](#socketio-emit), відправка **emit'у** при приєдннання, та отримання **emit'y** в відповідь з IP того хто перший раз приєднався.
2. [Перевірка IP](#socketio-emit), Redirect користувача на головну, чи виведення помилки
3. Отримання [базової інформації](get-invoice.md) про заявку.
4. Моніторинг emit'у, `invoce:refetch`, повторне отримання інформаціїї про заявку, та у разі тому, якщо статус заявки `send card`, то виводити користувачеві карту, та кнопку для підтвердження [оплати](update-invoice.md#_3). 
У разі отриманні статусу `waitPhoto`, завантажувати фото на свій сервер та після надіслати посилання на це фото з допомогою [запиту](update-invoice.md#invoic_1).
У разі отримання статусу `success`, завершувати процесс заявки.
У разі отримання іншого статусу, [транслітерувати](get-invoice.md#_2) цей статус користувачеві на екран.

## Стислий приклад консольного Node.js проекту
У проекті використанні всі методи, що були розписанні у нашій документації.
[GitHub Link](https://github.com/tihiydo/nl-trade-api-console-example)
